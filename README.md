APIncrementalStore
==================

Cutting the long story short, after StackMob [went to hell](https://blog.stackmob.com/2014/02/stackmob-announcement/) and all my development based on that SDK dragged along with it, I decided to implement my own `NSIncrementalStore` subclass.
Yes I have looked around for alternatives and even taking into account what is available, none of them are at the moment capable of supporting how I had designed my app.
I need an implementation that works most of time offline and sync with the backend BaaS when internet is available, which is quite the opposite of the APIs that I had found.
Special thanks to the great Mattt Thompson for the inspiring [AFIncrementalStore] (https://github.com/AFNetworking/AFIncrementalStore).
The code is based on Apple guidelines for [IncrementalStore Programming Guide] (https://developer.apple.com/library/mac/documentation/DataManagement/Conceptual/IncrementalStorePG/Introduction/Introduction.html#//apple_ref/doc/uid/TP40010706)

There are basically three main classes:

1) `APIncrementalStore` - this is the `NSIncrementalStore` subclass that implements what is required to handle the Core Data context.

2) `APDiskCache` - the APIncrementalStore uses this class as a local cache to respond to all the requests. This class exchanges NSDictionaries representations of the managed objects and uses a objectID to uniquely identify them across the managed contexts (`NSIncrementalStore` and Disk Cache). This class uses a complete core data stack to store the cached objects. There will be one sqlite store for each logged user, so that on distinct cache per user.

3) `APParseConnector` - Responsible for merging the local cache context in background as requested by the cache. Please be mindful that relationships are being represented as Parse Pointers for Core Data To-One and Parse Relationships for Core Data To-Many relationships. All relationships have its inverse reflected at Parse as well for consistency sake. At the moment this class does not support Parse Array Relationships. 

I will include descent documentation in the next weeks, for the time being take a look at the folder Example in the repository, you are going to find a very basic usage of this library.


###Additional columns to Parse classes
Two new columns are necessary on each Parse class that will sync with your Core Data Model:

1) *apObjectUID*: this is the unique identifier generated by APIncrementalStore. The Parse self created objectId is not being used as it can't be created localy, it requires that we save the object first then the SDK sets it to the object. As the main motivation of this repo is the capability of working most of time offline we need to use our own custom object identifier.

2) *apObjectIsDeleted*: the clients don't delete any object, the objects are "marked" as deleted using this property to allow others to sync the deleted objects and properly update their databases. You may want to implement a Parse Cloud Code to execute a "garbage" collector say every 60 days to clean it, you just need to ensure that all clients have synced before you clean it.

3) *apObjectEntityName*: through this attribute the `APIncrementalStore` adds support to Core Data Entity Inheritance. Only the root entities will be created at Parse, all remaining subentieis will be identified by this attribute. Therefore all attributes and relationships from the root class and its subentities will share the same Parse Class.

###Installation
Easy, you may clone it locally or use CocoaPods:

```
platform :ios, '7.0'
pod 'APIncrementalStore' , :git => 'https://github.com/flavionegrao/APIncrementalStore.git'
```

### Run the example app

1) Download the project

2) Create a Parse account and a test App you may name it whatever you want.

3) On your new test Parse App create a class User and add a new object to it with username:test_user and password:1234

4) Navigate to the *Example* project directory in the Terminal

5) Run the following command: `pod update`  - [Install cocoapods](http://guides.cocoapods.org/using/getting-started.html#getting-started) if you don't have it.

6) Open `APIncrementalStore.xcworkspace` in Xcode

7) Navigate to the *Example* project's `AppDelegate.m` file and set the `APParsepApplicationId` and `APParseClientKey`

8) You may run it on multiple devices (iOS Simulator + real iOS devices) to check to syncronization process

###Few tips when using the library:
- Don't forget to set Parse keys
- Login with an user (`PFUser`) and pass it as parameter to `APIncrementalStore`.
- `APParseConnector` will sync all entities found on your model and use the exactly same entity names to find the classes from Parse.

###Parse ACLs
`APIncrementalStore` tries to be as much agnostic as possible in regards to the backend webservice, thus pretty much only `APParseConnector` class deals with Parse. If you want to deal with ACLs I can see two ways you can achieve it:

1) Use a default ACL set perhaps when your user successfuly login at Parse:
```
PFACL *defaultACL = [PFACL ACL];
// Everybody can read objects created by this user
[defaultACL setPublicReadAccess:YES];
// Moderators can also modify these objects
[defaultACL setWriteAccess:YES forRoleWithName:@"Moderators"];
// And the user can read and modify its own objects
[PFACL setDefaultACL:defaultACL withAccessForCurrentUser:YES];
```
See [Parse Documentation](https://www.parse.com/docs/ios_guide#roles/iOS) for more information

2) If you want to set ACL individually to objects you have created localy add a property *__ACL* to your core data entity. `APIncrementalStore` will add ACL to a Parse Object when it finds a managed object that is being synced and
 contains a binary (NSData) property called *__ACL*. The property must be set as Binary and his content should be a JSON object UTF-8 encoded Parse ACL. Follow the same Parse ACL structure found on the REST API methods:
 ```
 {
    "8TOXdXf3tz": { "write": true },
    "role:Members": { "read": true },
    "role:Moderators": {"write": true }
 }
 ```
 Use PFObject objectID to identify specific users or role:<Role Name> for roles.
 On the example project you will find a helper method that shows how to create and included it to a managed object.
 ```-[CoreDataController addWriteAccess:readAccess:isRole:forParseIdentifier:forManagedObject:managedObject:]```
 
 To adjust your model and avoid including the *__ACL* property by hand to each of your entities you may include a method to add it programatically to all of them.
 
 ```
 - (NSManagedObjectModel*) model {
    
    NSManagedObjectModel* model = [NSManagedObjectModel mergedModelFromBundles:nil];
    NSManagedObjectModel *adjustedModel = [model copy];
    
    for (NSEntityDescription *entity in adjustedModel.entities) {
        
        // Don't add properties for sub-entities, as they already exist in the super-entity
        if ([entity superentity]) {
            continue;
        }
        
        NSAttributeDescription *objectACLProperty = [[NSAttributeDescription alloc] init];
        [objectACLProperty setName:@"__ACL"];
        [objectACLProperty setAttributeType:NSBinaryDataAttributeType];
        [objectACLProperty setOptional:YES];
        [objectACLProperty setIndexed:NO];
        
        [entity setProperties:[entity.properties arrayByAddingObjectsFromArray:@[objectACLProperty]]];
    }
    return adjustedModel;
}
```
 
 The Parse iOS-SDK doesn't allow us to inspect any existing ACL unless you know the user/role and you ask
 for the existing previlegies on that object. Therefore 'APIncrementalStore' will only add ACLs to object, but it will not change any existent privileges.

###Unit Testing
On `UnitTestingCommon.m` config a valid Parse User/Password.
Use a test Parse App as it will include few additional classes needed for testing.

###Version history
####v.0.2.9
Added support to [Core Data Entity Inheritance](https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/CoreData/Articles/cdMOM.html#//apple_ref/doc/uid/TP40002328-SW11) 



###Disclaimer
APIncrementalStore is not affiliated, associated, authorized, endorsed by, or in any way officially connected with Parse.com, Parse Inc., or any of its subsidiaries or its affiliates. 
The official Parse web site is available at [www.parse.com](www.parse.com)

###License
APIncrementalStore is available under the MIT license. 
See the LICENSE file for more info.


Cheers. Flavio


